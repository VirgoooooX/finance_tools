<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <link rel="icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>财务数据分析</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="/static/styles.css?v=6" rel="stylesheet">
</head>
<body>
  
  <header class="header">
    <div class="brand">
      <i class="bi bi-pie-chart-fill"></i>
      <span>财务数据分析</span>
    </div>

    <div class="nav-tabs-custom" id="tabs">
      <!-- 动态生成的工具 Tabs 将插入在这里 -->
      <button class="nav-tab" data-tab="tab-logs"><i class="bi bi-journal-text"></i>日志</button>
    </div>
    
    <div class="header-controls">
      <select id="globalToolSelect" class="form-select"></select>
      <button id="btnStartHeader" class="btn btn-accent btn-sm"><i class="bi bi-play-fill"></i>开始</button>
      <button id="btnStopHeader" class="btn btn-danger btn-sm" disabled><i class="bi bi-stop-fill"></i>停止</button>
      <div class="badge badge-subtle badge-status">
        <span class="badge-dot"></span>
        <span id="statusText">就绪</span>
      </div>
    </div>
  </header>

  <div class="app-container">
    <!-- Iframe Host -->
    <div id="toolModeHost" class="d-none">
      <div class="card" style="margin: 0; border: none; box-shadow: none; background: transparent;">
        <div class="card-body" style="padding: 0;">
          <iframe id="toolWebFrame" style="width: 100%; height: calc(100vh - 80px); border: 0; background: var(--bg);"></iframe>
        </div>
      </div>
    </div>
    
    <!-- Logs Tab (Global) -->
    <div id="tab-logs" class="tab-pane d-none">
      <div class="card">
        <div class="card-header">
          <div class="card-title">系统日志</div>
          <div class="d-flex gap-2">
            <button class="btn btn-secondary btn-sm" id="btnClearLogs"><i class="bi bi-trash"></i> 清空</button>
            <button class="btn btn-secondary btn-sm" id="btnCopyLogs"><i class="bi bi-clipboard"></i> 复制</button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          <div id="logs" class="log-container" style="border-radius: 0 0 var(--radius-lg) var(--radius-lg); border: none; height: calc(100vh - 180px);"></div>
        </div>
      </div>
    </div>

  </div>
  
<script>
let es = null;
let _toolsLoadedOnce = false;
let _toolsState = { tools: [], defaultToolId: '', currentToolId: '' };
let _toolWebState = { toolId: '', entryUrl: '', manifest: {}, lastTab: '' };

// --- Router ---
function showTab(id) {
  // Update UI active state
  document.querySelectorAll('#tabs .nav-tab').forEach(b => {
    b.classList.toggle('active', b.getAttribute('data-tab') === id);
  });

  // Handle Global Logs
  if (id === 'tab-logs') {
    _setToolModeHostVisible(false);
    document.getElementById('tab-logs').classList.remove('d-none');
    document.getElementById('tab-logs').style.display = 'block';
    return;
  }

  // Handle Tool Tabs
  document.getElementById('tab-logs').classList.add('d-none');
  document.getElementById('tab-logs').style.display = 'none';
  
  if (_isToolMode()) {
    _setToolModeHostVisible(true);
    const key = _toolTabKeyFromPaneId(id);
    navigateToolTab(key);
  }
}

document.getElementById('tabs').addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-tab]');
  if (!btn) return;
  showTab(btn.getAttribute('data-tab'));
});

function _isToolMode() {
  return !!_toolsState.currentToolId;
}

function _setToolModeHostVisible(visible) {
  const host = document.getElementById('toolModeHost');
  if (!host) return;
  host.classList.toggle('d-none', !visible);
  host.style.display = visible ? 'block' : 'none';
}

function _getToolWebFrame() { return document.getElementById('toolWebFrame'); }

function _toolTabKeyFromPaneId(paneId) {
  return String(paneId || '').replace(/^tab-/, '');
}

function _renderToolTabs() {
  const container = document.getElementById('tabs');
  // Remove all except logs
  const logsBtn = container.querySelector('[data-tab="tab-logs"]');
  container.innerHTML = '';
  
  const m = _toolWebState.manifest || {};
  const tabs = Array.isArray(m.tabs) ? m.tabs : [];
  
  // Create tool tabs
  tabs.forEach(t => {
    const btn = document.createElement('button');
    btn.className = 'nav-tab';
    btn.setAttribute('data-tab', `tab-${t.id}`);
    btn.innerHTML = `<i class="${t.icon || 'bi-window'}"></i>${t.name || t.id}`;
    container.appendChild(btn);
  });
  
  // Append logs at end
  if (logsBtn) container.appendChild(logsBtn);
}

// --- Tool Loading ---
async function initToolSelector() {
  if (_toolsLoadedOnce) return;
  _toolsLoadedOnce = true;
  const sel = document.getElementById('globalToolSelect');
  sel.addEventListener('change', () => setCurrentToolId(sel.value));
  try {
    const resp = await fetch('/api/tools');
    const data = await resp.json();
    const tools = data.tools || [];
    const defaultId = data.default || '';
    _toolsState = { tools, defaultToolId: defaultId, currentToolId: defaultId };
    
    sel.innerHTML = '';
    for (const t of tools) {
      const opt = document.createElement('option');
      opt.value = t.id;
      opt.innerText = t.name ? `${t.name}（${t.id}）` : t.id;
      sel.appendChild(opt);
    }
    sel.value = defaultId;
    setCurrentToolId(defaultId);
  } catch {
    sel.innerHTML = '<option>加载失败</option>';
  }
}

async function setCurrentToolId(toolId) {
  const tid = toolId || _toolsState.defaultToolId;
  _toolsState.currentToolId = tid;
  
  // Load tool manifest & entry
  _toolWebState = { toolId: '', entryUrl: '', manifest: {}, lastTab: '' };
  try {
    const resp = await fetch('/api/tools/' + encodeURIComponent(tid) + '/web');
    const data = await resp.json();
    if (data.ok) {
      _toolWebState.toolId = tid;
      _toolWebState.entryUrl = data.entry_url;
      _toolWebState.manifest = data.manifest || {};
    }
  } catch {}
  
  _renderToolTabs();
  
  // Select first tab
  const firstTab = (_toolWebState.manifest.tabs && _toolWebState.manifest.tabs.length > 0) 
    ? `tab-${_toolWebState.manifest.tabs[0].id}` 
    : 'tab-logs';
  showTab(firstTab);
}

function navigateToolTab(key) {
  const frame = _getToolWebFrame();
  if (!frame || !_toolWebState.entryUrl) return;
  const nextUrl = `${_toolWebState.entryUrl}#tab=${encodeURIComponent(key)}`;
  if (frame.getAttribute('src') !== nextUrl) { // Use getAttribute to avoid full url resolve check issues
     frame.src = nextUrl;
  } else {
     // If src matches, maybe just hash change needed or reload?
     // Iframe hash change doesn't always trigger reload if src is same.
     // Access contentWindow to be sure?
     try { frame.contentWindow.location.hash = `#tab=${encodeURIComponent(key)}`; } catch {}
  }
  _toolWebState.lastTab = key;
}

// --- Global Controls ---
function setStatus(text) {
  document.getElementById('statusText').innerText = text || '';
}

function appendLog(line) {
  const logs = document.getElementById('logs');
  const div = document.createElement('div');
  div.className = 'log-line';
  div.innerText = line;
  logs.appendChild(div);
  logs.scrollTop = logs.scrollHeight;
}

function setButtons(running) {
  document.getElementById('btnStartHeader').disabled = !!running;
  document.getElementById('btnStopHeader').disabled = !running;
}

async function startRun() {
  document.getElementById('logs').innerHTML = '';
  await fetch('/api/run/start?tool_id=' + encodeURIComponent(_toolsState.currentToolId), { method: 'POST' });
  setStatus('运行中...');
  setButtons(true);
  showTab('tab-logs'); // Auto jump to logs
  if (!es) connectStream();
}

async function stopRun() {
  await fetch('/api/run/stop', { method: 'POST' });
  setStatus('停止中...');
}

// --- Stream & Events ---
function connectStream() {
  es = new EventSource('/api/stream');
  es.addEventListener('log', e => {
    let d = {}; try { d = JSON.parse(e.data); } catch {}
    const msg = d.message || e.data;
    appendLog(msg);
    _postToolWebEvent('log', d);
  });
  es.addEventListener('status', e => {
    let d = {}; try { d = JSON.parse(e.data); } catch {}
    const msg = d.message || e.data;
    setStatus(msg);
    _postToolWebEvent('status', d);
  });
  es.addEventListener('progress', e => {
    let d = {}; try { d = JSON.parse(e.data); } catch {}
    _postToolWebEvent('progress', d);
  });
  es.addEventListener('done', e => {
    let d = {}; try { d = JSON.parse(e.data); } catch {}
    setStatus('完成');
    setButtons(false);
    _postToolWebEvent('done', d);
    
    // Auto jump to results if available
    if (d.result && !d.result.cancelled && !d.result.errors?.length) {
       const hasResults = (_toolWebState.manifest.tabs || []).find(t => t.id === 'results');
       if (hasResults) showTab('tab-results');
    }
  });
}

function _postToolWebEvent(event, data) {
  const frame = _getToolWebFrame();
  if (frame && frame.contentWindow) {
    frame.contentWindow.postMessage({ type: 'fa.event', event, data }, '*');
  }
}

// --- Init ---
document.getElementById('btnStartHeader').addEventListener('click', startRun);
document.getElementById('btnStopHeader').addEventListener('click', stopRun);
document.getElementById('btnClearLogs').addEventListener('click', () => document.getElementById('logs').innerHTML = '');
document.getElementById('btnCopyLogs').addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(document.getElementById('logs').innerText); setStatus('已复制'); } catch {}
});

initToolSelector().then(() => {
  fetch('/api/run/status').then(r=>r.json()).then(d => {
    setButtons(d.running);
    if(d.running) connectStream();
  });
});

</script>
</body>
</html>
