<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>财务数据分析</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="/static/styles.css?v=4" rel="stylesheet">
</head>
<body>
  
  <header class="header">
    <div class="brand">
      <i class="bi bi-pie-chart-fill"></i>
      <span>财务数据分析</span>
    </div>
    
    <div class="header-controls">
      <div class="badge badge-subtle">
        <span class="badge-dot"></span>
        <span id="statusText">就绪</span>
      </div>
      <div class="badge badge-subtle">
        <i class="bi bi-hourglass-split"></i>
        <span id="progressDetail">0/1</span>
      </div>
      
      <div class="progress-wrapper">
        <div id="progressBar" class="progress-fill" style="width: 0%"></div>
      </div>
    </div>
  </header>

  <div class="app-container">
    
    <div class="nav-tabs-custom" id="tabs">
      <button class="nav-tab active" data-tab="tab-config"><i class="bi bi-sliders"></i>配置</button>
      <button class="nav-tab" data-tab="tab-query"><i class="bi bi-search"></i>查询</button>
      <button class="nav-tab" data-tab="tab-run"><i class="bi bi-play-circle"></i>运行</button>
      <button class="nav-tab" data-tab="tab-logs"><i class="bi bi-journal-text"></i>日志</button>
      <button class="nav-tab" data-tab="tab-results"><i class="bi bi-table"></i>结果</button>
    </div>

    <!-- Configuration Tab -->
    <div id="tab-config" class="tab-pane">
      <div class="grid grid-cols-3">
        <!-- Main Configuration -->
        <div class="col-span-2">
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-gear"></i>核心配置</div>
              <div class="d-flex gap-2">
                <button id="btnReloadCfg" class="btn btn-secondary btn-sm"><i class="bi bi-arrow-clockwise"></i>重载</button>
                <button id="btnSaveCfg" class="btn btn-primary btn-sm"><i class="bi bi-save"></i>保存</button>
              </div>
            </div>
            
            <div class="card-body">
              <div class="grid grid-cols-2">
                <div class="form-group col-span-2">
                  <label class="form-label">输入目录</label>
                  <input id="input_dir" class="form-control" placeholder="例如：L:\Web\Financial data analysis">
                  <div class="form-help">要扫描的 Excel 所在文件夹</div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">文件匹配模式</label>
                  <input id="file_glob" class="form-control" placeholder="例如：*.xlsx">
                </div>
                
                <div class="form-group">
                  <label class="form-label">输出目录</label>
                  <input id="output_dir" class="form-control" placeholder="例如：L:\Web\Financial data analysis">
                </div>
                
                <div class="form-group col-span-2">
                  <label class="form-label">输出文件名</label>
                  <input id="output_basename" class="form-control" placeholder="例如：清洗后的AI标准财务表.xlsx">
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-funnel"></i>关键字识别</div>
            </div>
            <div class="card-body">
              <div class="grid grid-cols-3">
                <div>
                  <label class="form-label">BS Sheet 关键字</label>
                  <input id="sheet_keyword_bs" class="form-control">
                </div>
                <div>
                  <label class="form-label">PL Sheet 关键字</label>
                  <input id="sheet_keyword_pl" class="form-control">
                </div>
                <div>
                  <label class="form-label">CF Sheet 关键字</label>
                  <input id="sheet_keyword_cf" class="form-control">
                </div>
                
                <div>
                  <label class="form-label">BS 表头关键字</label>
                  <input id="header_keyword_bs" class="form-control">
                </div>
                <div>
                  <label class="form-label">PL 表头关键字</label>
                  <input id="header_keyword_pl" class="form-control">
                </div>
                <div>
                  <label class="form-label">CF 表头关键字</label>
                  <input id="header_keyword_cf" class="form-control">
                </div>
              </div>
            </div>
          </div>
          
           <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-calendar-check"></i>日期与验证</div>
            </div>
            <div class="card-body">
              <div class="grid grid-cols-3">
                <div>
                  <label class="form-label">BS 日期单元格</label>
                  <input id="date_cells_bs" class="form-control" placeholder="行,列 (从0开始)">
                </div>
                <div>
                  <label class="form-label">PL 日期单元格</label>
                  <input id="date_cells_pl" class="form-control" placeholder="行,列">
                </div>
                <div>
                  <label class="form-label">CF 日期单元格</label>
                  <input id="date_cells_cf" class="form-control" placeholder="行,列">
                </div>
                
                <div>
                  <label class="form-label">验证容差</label>
                  <input id="validation_tolerance" class="form-control" placeholder="0.01">
                </div>
                
                <div class="col-span-2 d-flex items-center gap-4 mt-4">
                  <div class="d-flex items-center gap-2">
                    <input id="generate_validation" type="checkbox">
                    <label for="generate_validation" class="form-label" style="margin:0">生成验证报告</label>
                  </div>
                  <div class="d-flex items-center gap-2">
                    <input id="generate_metrics" type="checkbox">
                    <label for="generate_metrics" class="form-label" style="margin:0">生成财务指标</label>
                  </div>
                  <div class="d-flex items-center gap-2">
                    <input id="exclude_output_files" type="checkbox">
                    <label for="exclude_output_files" class="form-label" style="margin:0">排除输出文件</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sidebar / Actions -->
        <div>
          <div class="card">
            <div class="card-header">
              <div class="card-title"><i class="bi bi-lightning-charge"></i>快捷操作</div>
            </div>
            <div class="card-body">
              <div class="grid">
                <div class="d-flex gap-2">
                    <select id="presetSelect" class="form-select flex-1">
                      <option value="">选择预设模式...</option>
                      <option value="merge">合并报表</option>
                      <option value="jingzhu">精铸</option>
                      <option value="xincl">新材料</option>
                      <option value="quick">快速模式</option>
                      <option value="redengjingya">热等静压</option>
                    </select>
                    <button id="btnApplyPreset" class="btn btn-secondary">应用</button>
                </div>
                
                <button class="btn btn-primary w-full" id="btnSaveCfg2"><i class="bi bi-save"></i> 保存配置</button>
                <button class="btn btn-secondary w-full" id="btnScan2"><i class="bi bi-search"></i> 扫描文件</button>
                <button class="btn btn-accent w-full" id="btnStart2"><i class="bi bi-play-fill"></i> 开始运行</button>
                <button class="btn btn-danger w-full" id="btnStop2" disabled><i class="bi bi-stop-fill"></i> 停止运行</button>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <div class="card-title">
                <i class="bi bi-file-earmark-text"></i>
                文件预览
              </div>
              <button class="btn btn-secondary btn-sm" id="btnClearFiles">清空</button>
            </div>
            <div class="card-body" style="padding: 0;">
               <div id="filesPreview" class="text-mono" style="padding: 1rem; max-height: 400px; overflow-y: auto; font-size: 0.85rem; color: var(--text-secondary); white-space: pre-wrap;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Query Tab -->
    <div id="tab-query" class="tab-pane d-none">
      <div class="card">
        <div class="card-header">
          <div class="card-title"><i class="bi bi-filter"></i>数据筛选</div>
          <div class="d-flex gap-2">
             <button id="btnReloadQueryOptions" class="btn btn-secondary btn-sm">刷新选项</button>
             <button id="btnQuery" class="btn btn-primary btn-sm">执行查询</button>
          </div>
        </div>
        <div class="card-body">
          <div class="grid grid-cols-4">
             <div class="form-group" style="grid-column: span 2;">
               <label class="form-label">科目包含</label>
               <input id="qSubject" class="form-control" placeholder="例如：未分配利润 / 银行存款">
             </div>
             <div>
               <label class="form-label">金额范围 (最小)</label>
               <input id="qMinAmount" class="form-control" placeholder="0">
             </div>
             <div>
               <label class="form-label">金额范围 (最大)</label>
               <input id="qMaxAmount" class="form-control" placeholder="1000000">
             </div>
             
             <div>
               <label class="form-label">源文件</label>
               <select id="qSourceFile" class="form-select"></select>
             </div>
             <div>
               <label class="form-label">日期</label>
               <select id="qDate" class="form-select"></select>
             </div>
             <div>
               <label class="form-label">报表类型</label>
               <select id="qReportType" class="form-select"></select>
             </div>
             <div>
               <label class="form-label">时间属性</label>
               <select id="qTimeAttr" class="form-select"></select>
             </div>
          </div>
          
          <div class="d-flex justify-between items-center mt-4 pt-4" style="border-top: 1px solid var(--border-color)">
             <div id="qMeta" class="text-mono" style="color: var(--text-secondary); font-size: 0.85rem;"></div>
             <div class="d-flex gap-2">
               <button id="btnQueryPrev" class="btn btn-secondary btn-sm">上一页</button>
               <button id="btnQueryNext" class="btn btn-secondary btn-sm">下一页</button>
             </div>
          </div>
        </div>
      </div>
      
      <div class="table-container">
        <table class="financial-table">
          <thead id="cleanedHead"></thead>
          <tbody id="cleanedBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Run Tab -->
    <div id="tab-run" class="tab-pane d-none">
      <div class="card" style="max-width: 800px; margin: 0 auto;">
        <div class="card-body text-center" style="padding: 4rem 2rem;">
          <div style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;">
            <i class="bi bi-rocket-takeoff"></i>
          </div>
          <h2 style="font-weight: 600; margin-bottom: 0.5rem;">准备就绪</h2>
          <p style="color: var(--text-secondary); margin-bottom: 2rem;">点击下方按钮开始处理财务数据。运行日志将实时显示。</p>
          
          <div class="grid grid-cols-3 gap-4 mb-4" style="max-width: 600px; margin: 0 auto 2rem auto;">
             <div style="background: var(--bg-subtle); padding: 1rem; border-radius: var(--radius-md);">
               <div style="font-size: 0.85rem; color: var(--text-secondary);">状态</div>
               <div id="runStatusKpi" style="font-weight: 600; font-size: 1.1rem;">就绪</div>
             </div>
             <div style="background: var(--bg-subtle); padding: 1rem; border-radius: var(--radius-md);">
               <div style="font-size: 0.85rem; color: var(--text-secondary);">进度</div>
               <div id="runProgressKpi" style="font-weight: 600; font-size: 1.1rem;">0/1</div>
             </div>
             <div style="background: var(--bg-subtle); padding: 1rem; border-radius: var(--radius-md);">
               <div style="font-size: 0.85rem; color: var(--text-secondary);">当前文件</div>
               <div id="runFileKpi" class="text-mono" style="font-weight: 600; font-size: 1.1rem;">-</div>
             </div>
          </div>
          
          <div class="d-flex gap-2 justify-center" style="justify-content: center;">
            <button class="btn btn-accent btn-lg" id="btnStart3" style="padding: 0.75rem 2rem;"><i class="bi bi-play-fill"></i> 开始运行</button>
            <button class="btn btn-danger btn-lg" id="btnStop3" disabled style="padding: 0.75rem 2rem;"><i class="bi bi-stop-fill"></i> 停止</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Logs Tab -->
    <div id="tab-logs" class="tab-pane d-none">
      <div class="card">
        <div class="card-header">
          <div class="card-title">系统日志</div>
          <div class="d-flex gap-2">
            <button class="btn btn-secondary btn-sm" id="btnClearLogs"><i class="bi bi-trash"></i> 清空</button>
            <button class="btn btn-secondary btn-sm" id="btnCopyLogs"><i class="bi bi-clipboard"></i> 复制</button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          <div id="logs" class="log-container" style="border-radius: 0 0 var(--radius-lg) var(--radius-lg); border: none;"></div>
        </div>
      </div>
    </div>

    <!-- Results Tab -->
    <div id="tab-results" class="tab-pane d-none">
      <div class="card">
        <div class="card-header">
          <div class="card-title">输出文件</div>
        </div>
        <div class="card-body">
          <div class="grid grid-cols-3">
            <div>
              <div class="form-label">清洗数据</div>
              <div class="d-flex gap-2 mt-1">
                <div id="outCleaned" class="text-mono form-control flex-1" style="background: var(--bg-subtle); border: none; overflow: hidden; text-overflow: ellipsis;"></div>
                <button class="btn btn-secondary" onclick="openPath('cleaned')">打开</button>
              </div>
            </div>
            <div>
              <div class="form-label">验证报告</div>
              <div class="d-flex gap-2 mt-1">
                <div id="outValidation" class="text-mono form-control flex-1" style="background: var(--bg-subtle); border: none; overflow: hidden; text-overflow: ellipsis;"></div>
                <button class="btn btn-secondary" onclick="openPath('validation')">打开</button>
              </div>
            </div>
            <div>
              <div class="form-label">财务指标</div>
              <div class="d-flex gap-2 mt-1">
                <div id="outMetrics" class="text-mono form-control flex-1" style="background: var(--bg-subtle); border: none; overflow: hidden; text-overflow: ellipsis;"></div>
                <button class="btn btn-secondary" onclick="openPath('metrics')">打开</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
           <div class="card-title" style="color: var(--danger);">不平衡记录预览 (Top 200)</div>
        </div>
        <div class="table-container" style="border:none; box-shadow:none;">
           <table class="financial-table">
             <thead>
               <tr>
                 <th>源文件</th>
                 <th>来源Sheet</th>
                 <th>日期</th>
                 <th>时间属性</th>
                 <th>差额</th>
                 <th>验证结果</th>
               </tr>
             </thead>
             <tbody id="unbalancedBody"></tbody>
           </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">验证报告明细</div></div>
        <div class="table-container" style="border:none; box-shadow:none;">
           <table class="financial-table">
             <thead id="validationHead"></thead>
             <tbody id="validationBody"></tbody>
           </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">财务指标明细</div></div>
        <div class="table-container" style="border:none; box-shadow:none;">
           <table class="financial-table">
             <thead id="metricsHead"></thead>
             <tbody id="metricsBody"></tbody>
           </table>
        </div>
      </div>
    </div>

  </div>
  
  <div style="display:none" id="hostInfo"></div>

<script>
let latestPaths = { cleaned: '', validation: '', metrics: '' };
let es = null;
let lastProgress = { current: 0, total: 1, detail: '' };
let queryState = { offset: 0, limit: 200, total: 0 };

const PRESETS = {
  merge: { name: '合并', bs: 'BS-合并', pl: 'PL-合并', cf: 'CF-合并' },
  jingzhu: { name: '精铸', bs: '精铸BS新', pl: '精铸PL新', cf: '精铸现金流量表' },
  xincl: { name: '新材料', bs: '新材料BS新', pl: '新材料PL新', cf: '新材料现金流量表' },
  quick: { name: '快速', bs: '快速BS新', pl: '快速PL新', cf: '快速现金流量表' },
  redengjingya: { name: '热等静压', bs: '热等静压BS新', pl: '热等静压PL新', cf: '热等静压现金流量表' },
};

function showTab(id) {
  // Hide all panes
  document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('d-none'));
  document.querySelectorAll('.tab-pane').forEach(el => el.style.display = 'none'); // Ensure display none
  
  // Show target pane
  const target = document.getElementById(id);
  if(target) {
      target.classList.remove('d-none');
      target.style.display = 'block';
  }
  
  // Update buttons
  document.querySelectorAll('#tabs .nav-tab').forEach(b => {
    b.classList.toggle('active', b.getAttribute('data-tab') === id);
  });
}

document.getElementById('tabs').addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-tab]');
  if (!btn) return;
  showTab(btn.getAttribute('data-tab'));
});

// Initialize first tab
showTab('tab-config');

function setStatus(text) {
  document.getElementById('statusText').innerText = text || '';
  const kpi = document.getElementById('runStatusKpi');
  if(kpi) kpi.innerText = text || '';
}

function appendLog(line) {
  const logs = document.getElementById('logs');
  const div = document.createElement('div');
  div.className = 'log-line';
  div.innerText = line;
  logs.appendChild(div);
  logs.scrollTop = logs.scrollHeight;
}

function setProgress(current, total, detail) {
  const t = Math.max(1, parseInt(total || 1));
  const c = Math.max(0, parseInt(current || 0));
  const pct = Math.min(100, Math.max(0, Math.round((c / t) * 100)));
  
  const bar = document.getElementById('progressBar');
  if(bar) bar.style.width = pct + '%';
  
  const det = document.getElementById('progressDetail');
  if(det) det.innerText = `${c}/${t} ${detail || ''}`.trim();
  
  const kpiProg = document.getElementById('runProgressKpi');
  if(kpiProg) kpiProg.innerText = `${c}/${t}`;
  
  const kpiFile = document.getElementById('runFileKpi');
  if(kpiFile) kpiFile.innerText = (detail || '-');
  
  lastProgress = { current: c, total: t, detail: detail || '' };
}

function cellsToText(cells) {
  if (!Array.isArray(cells)) return '';
  return cells.map(x => Array.isArray(x) && x.length >= 2 ? `${x[0]},${x[1]}` : '').filter(Boolean).join(';');
}

function textToCells(text) {
  const s = (text || '').trim();
  if (!s) return [];
  return s.split(/[;\n|]+/).map(x => x.trim()).filter(Boolean).map(chunk => {
    const parts = chunk.split(/[, \t]+/).map(x => x.trim()).filter(Boolean);
    if (parts.length < 2) return null;
    const r = parseInt(parts[0]); const c = parseInt(parts[1]);
    if (Number.isNaN(r) || Number.isNaN(c)) return null;
    return [r, c];
  }).filter(Boolean);
}

function getCfgFromForm() {
  const tol = document.getElementById('validation_tolerance').value;
  return {
    input_dir: document.getElementById('input_dir').value.trim(),
    file_glob: document.getElementById('file_glob').value.trim(),
    output_dir: document.getElementById('output_dir').value.trim(),
    output_basename: document.getElementById('output_basename').value.trim(),
    generate_validation: document.getElementById('generate_validation').checked,
    generate_metrics: document.getElementById('generate_metrics').checked,
    exclude_output_files: document.getElementById('exclude_output_files').checked,
    sheet_keyword_bs: document.getElementById('sheet_keyword_bs').value.trim(),
    sheet_keyword_pl: document.getElementById('sheet_keyword_pl').value.trim(),
    sheet_keyword_cf: document.getElementById('sheet_keyword_cf').value.trim(),
    header_keyword_bs: document.getElementById('header_keyword_bs').value.trim(),
    header_keyword_pl: document.getElementById('header_keyword_pl').value.trim(),
    header_keyword_cf: document.getElementById('header_keyword_cf').value.trim(),
    date_cells_bs: textToCells(document.getElementById('date_cells_bs').value),
    date_cells_pl: textToCells(document.getElementById('date_cells_pl').value),
    date_cells_cf: textToCells(document.getElementById('date_cells_cf').value),
    validation_tolerance: parseFloat(tol ? tol : '0.01')
  };
}

function fillForm(cfg) {
  document.getElementById('input_dir').value = cfg.input_dir || '';
  document.getElementById('file_glob').value = cfg.file_glob || '';
  document.getElementById('output_dir').value = cfg.output_dir || '';
  document.getElementById('output_basename').value = cfg.output_basename || '';
  document.getElementById('generate_validation').checked = !!cfg.generate_validation;
  document.getElementById('generate_metrics').checked = !!cfg.generate_metrics;
  document.getElementById('exclude_output_files').checked = !!cfg.exclude_output_files;
  document.getElementById('sheet_keyword_bs').value = cfg.sheet_keyword_bs || '';
  document.getElementById('sheet_keyword_pl').value = cfg.sheet_keyword_pl || '';
  document.getElementById('sheet_keyword_cf').value = cfg.sheet_keyword_cf || '';
  document.getElementById('header_keyword_bs').value = cfg.header_keyword_bs || '';
  document.getElementById('header_keyword_pl').value = cfg.header_keyword_pl || '';
  document.getElementById('header_keyword_cf').value = cfg.header_keyword_cf || '';
  document.getElementById('date_cells_bs').value = cellsToText(cfg.date_cells_bs);
  document.getElementById('date_cells_pl').value = cellsToText(cfg.date_cells_pl);
  document.getElementById('date_cells_cf').value = cellsToText(cfg.date_cells_cf);
  document.getElementById('validation_tolerance').value = (cfg.validation_tolerance != null ? cfg.validation_tolerance : 0.01);
}

function applyPresetToForm(presetKey) {
  const p = PRESETS[presetKey];
  if (!p) { setStatus('请选择预设'); return; }
  document.getElementById('sheet_keyword_bs').value = p.bs;
  document.getElementById('sheet_keyword_pl').value = p.pl;
  document.getElementById('sheet_keyword_cf').value = p.cf;

  const outEl = document.getElementById('output_basename');
  const knownPrefixes = Object.values(PRESETS).map(x => x && x.name ? `${x.name}_` : '').filter(Boolean);
  let base = (outEl.value || '').trim() || '清洗后的AI标准财务表.xlsx';
  for (const pre of knownPrefixes) {
    if (base.startsWith(pre)) {
      base = base.slice(pre.length);
      break;
    }
  }
  outEl.value = `${p.name}_${base}`;
  setStatus(`已套用预设：${p.name}`);
}

async function reloadCfg() {
  const resp = await fetch('/api/config');
  const data = await resp.json();
  fillForm(data);
  
  // 如果配置为空（即没有设置关键字），则默认加载“合并报表”预设
  if (!data.sheet_keyword_bs && !data.sheet_keyword_pl && !data.sheet_keyword_cf) {
    const sel = document.getElementById('presetSelect');
    if (sel) sel.value = 'merge';
    applyPresetToForm('merge');
  }
  
  setStatus('已加载配置');
}

async function saveCfg() {
  const payload = getCfgFromForm();
  const resp = await fetch('/api/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
  const data = await resp.json();
  fillForm(data);
  setStatus('已保存配置');
}

async function scanFiles() {
  await saveCfg();
  const resp = await fetch('/api/scan', { method: 'POST' });
  const data = await resp.json();
  const box = document.getElementById('filesPreview');
  if (!data.files || data.files.length === 0) {
    box.innerText = '未找到匹配文件';
    return;
  }
  const list = data.files.slice(0, 500).map(p => p.split(/[\\\/]/).pop()).join('\n');
  box.innerText = data.files.length > 500 ? list + `\n... 还有 ${data.files.length - 500} 个文件未显示` : list;
  setStatus(`扫描到 ${data.files.length} 个文件`);
}

function setButtons(running) {
  const setDisabled = (id, disabled) => {
    const el = document.getElementById(id);
    if (el) el.disabled = !!disabled;
  };
  // Removed old btnStart/Stop, only 2 and 3 remain
  setDisabled('btnStart2', !!running);
  setDisabled('btnStop2', !running);
  setDisabled('btnStart3', !!running);
  setDisabled('btnStop3', !running);
}

async function startRun() {
  document.getElementById('logs').innerHTML = '';
  document.getElementById('unbalancedBody').innerHTML = '';
  document.getElementById('validationHead').innerHTML = '';
  document.getElementById('validationBody').innerHTML = '';
  document.getElementById('metricsHead').innerHTML = '';
  document.getElementById('metricsBody').innerHTML = '';
  document.getElementById('outCleaned').innerText = '';
  document.getElementById('outValidation').innerText = '';
  document.getElementById('outMetrics').innerText = '';
  latestPaths = { cleaned: '', validation: '', metrics: '' };
  setProgress(0, 1, '');
  await saveCfg();
  const resp = await fetch('/api/run/start', { method: 'POST' });
  const data = await resp.json();
  if (!data.ok) {
    setStatus(data.message || '无法启动');
    return;
  }
  setStatus('运行中...');
  setButtons(true);
  showTab('tab-logs');
  if (!es) connectStream();
}

async function stopRun() {
  await fetch('/api/run/stop', { method: 'POST' });
  setStatus('正在停止...');
}

async function openPath(kind) {
  const path = (latestPaths[kind] || '').trim();
  if (!path) { setStatus('没有可打开的路径'); return; }
  try {
    const resp = await fetch('/api/open', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path }) });
    const data = await resp.json();
    if (data && data.ok) setStatus('已打开');
    else setStatus((data && data.message) ? data.message : '打开失败');
  } catch {
    setStatus('打开失败');
  }
}

function tryParseNumeric(v) {
  if (typeof v === 'number') return Number.isFinite(v) ? { kind: 'number', n: v } : null;
  if (typeof v !== 'string') return null;
  const s = v.trim();
  if (!s) return null;
  if (s === 'NaN' || s === 'Infinity' || s === '-Infinity') return null;
  const s1 = s.replace(/,/g, '');
  if (/^-?\d+(\.\d+)?%$/.test(s1)) return { kind: 'percent', n: Number(s1.slice(0, -1)) };
  if (/^-?\d+(\.\d+)?$/.test(s1)) return { kind: 'number', n: Number(s1) };
  return null;
}

function formatAccountingNumber(n) {
  if (!Number.isFinite(n)) return '';
  const nf = new Intl.NumberFormat('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  if (n < 0) return `(${nf.format(Math.abs(n))})`;
  return nf.format(n);
}

function setCellTextWithFormat(td, raw) {
  if (raw == null) { td.innerText = ''; return; }
  const parsed = tryParseNumeric(raw);
  if (parsed && parsed.kind === 'number' && Number.isFinite(parsed.n)) {
    td.classList.add('num');
    if (parsed.n < 0) td.classList.add('neg');
    td.innerText = formatAccountingNumber(parsed.n);
    return;
  }
  if (parsed && parsed.kind === 'percent' && Number.isFinite(parsed.n)) {
    td.classList.add('num');
    if (parsed.n < 0) td.classList.add('neg');
    td.innerText = `${formatAccountingNumber(parsed.n)}%`;
    return;
  }
  td.innerText = String(raw);
}

function renderUnbalanced(rows) {
  const body = document.getElementById('unbalancedBody');
  body.innerHTML = '';
  if (!Array.isArray(rows)) return;
  for (const r of rows) {
    const tr = document.createElement('tr');
    // Removed table-danger, use subtle coloring if needed
    // tr.className = 'table-danger'; 
    const cols = ['源文件', '来源Sheet', '日期', '时间属性', '差额', '验证结果'];
    for (const c of cols) {
      const td = document.createElement('td');
      setCellTextWithFormat(td, (r && r[c] != null) ? r[c] : '');
      if (c === '差额' || c === '验证结果') td.style.color = 'var(--danger)';
      tr.appendChild(td);
    }
    body.appendChild(tr);
  }
}

function buildColumns(rows, preferred) {
  const cols = [];
  const seen = new Set();
  const add = (k) => {
    if (!k || seen.has(k)) return;
    seen.add(k);
    cols.push(k);
  };
  for (const k of (preferred || [])) add(k);
  for (const r of (rows || [])) {
    if (!r) continue;
    for (const k of Object.keys(r)) add(k);
  }
  return cols;
}

function renderTable(headEl, bodyEl, rows, preferredCols, rowClassFn) {
  headEl.innerHTML = '';
  bodyEl.innerHTML = '';
  if (!Array.isArray(rows) || rows.length === 0) return;
  const cols = buildColumns(rows, preferredCols);
  const trh = document.createElement('tr');
  for (const c of cols) {
    const th = document.createElement('th');
    th.innerText = c;
    trh.appendChild(th);
  }
  headEl.appendChild(trh);
  for (const r of rows) {
    const tr = document.createElement('tr');
    const cls = rowClassFn ? rowClassFn(r) : '';
    if (cls) tr.className = cls;
    for (const c of cols) {
      const td = document.createElement('td');
      setCellTextWithFormat(td, (r && r[c] != null) ? r[c] : '');
      tr.appendChild(td);
    }
    bodyEl.appendChild(tr);
  }
}

function renderValidation(rows) {
  const head = document.getElementById('validationHead');
  const body = document.getElementById('validationBody');
  const preferred = ['源文件', '日期', '来源Sheet', '验证项目', '时间属性', '是否平衡', '差额', '验证结果'];
  // Removed table-danger for cleaner look, maybe just color text?
  renderTable(head, body, rows, preferred, (r) => (r && r['是否平衡'] === '否') ? 'row-danger' : '');
}

function renderMetrics(rows) {
  const head = document.getElementById('metricsHead');
  const body = document.getElementById('metricsBody');
  const preferred = ['源文件', '日期'];
  renderTable(head, body, rows, preferred, null);
}

function setSelectOptions(sel, values) {
  sel.innerHTML = '';
  const opt0 = document.createElement('option');
  opt0.value = '';
  opt0.innerText = '全部';
  sel.appendChild(opt0);
  for (const v of (values || [])) {
    const opt = document.createElement('option');
    opt.value = v;
    opt.innerText = v;
    sel.appendChild(opt);
  }
}

async function loadQueryOptions(force) {
  try {
    const resp = await fetch('/api/cleaned/options?force=' + (force ? '1' : '0'));
    const data = await resp.json();
    setSelectOptions(document.getElementById('qSourceFile'), data['源文件'] || []);
    setSelectOptions(document.getElementById('qDate'), data['日期'] || []);
    setSelectOptions(document.getElementById('qReportType'), data['报表类型'] || []);
    setSelectOptions(document.getElementById('qTimeAttr'), data['时间属性'] || []);
    document.getElementById('qMeta').innerText = `数据源：${(data.path || '').split(/[\\\\/]/).pop()} | 共 ${data.rows || 0} 行`;
  } catch {
    document.getElementById('qMeta').innerText = '未找到清洗表，请先运行生成';
  }
}

function getQueryPayload() {
  const numOrNull = (v) => {
    const s = (v || '').trim();
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  };
  return {
    subject: document.getElementById('qSubject').value.trim(),
    source_file: document.getElementById('qSourceFile').value,
    date: document.getElementById('qDate').value,
    report_type: document.getElementById('qReportType').value,
    time_attr: document.getElementById('qTimeAttr').value,
    min_amount: numOrNull(document.getElementById('qMinAmount').value),
    max_amount: numOrNull(document.getElementById('qMaxAmount').value),
    limit: queryState.limit,
    offset: queryState.offset,
  };
}

async function runQuery(resetOffset) {
  if (resetOffset) queryState.offset = 0;
  const p = getQueryPayload();
  const qs = new URLSearchParams();
  for (const [k, v] of Object.entries(p)) {
    if (v == null) continue;
    if (typeof v === 'string' && v.trim() === '') continue;
    qs.set(k, String(v));
  }
  try {
    const resp = await fetch('/api/cleaned/query?' + qs.toString());
    const data = await resp.json();
    queryState.total = data.total || 0;
    queryState.limit = data.limit || queryState.limit;
    queryState.offset = data.offset || 0;
    const meta = `命中 ${queryState.total} 行 | 当前 ${queryState.offset + 1}-${Math.min(queryState.offset + queryState.limit, queryState.total)}`;
    document.getElementById('qMeta').innerText = `数据源：${(data.path || '').split(/[\\\\/]/).pop()} | ${meta}`;
    const preferred = ['源文件', '日期', '报表类型', '大类', '科目', '时间属性', '金额', '来源Sheet'];
    renderTable(document.getElementById('cleanedHead'), document.getElementById('cleanedBody'), data.rows || [], preferred, null);
  } catch {
    setStatus('查询失败（请先运行生成清洗表）');
  }
}

function applyResult(res) {
  if (!res) return;
  latestPaths.cleaned = res.cleaned_path || '';
  latestPaths.validation = res.validation_path || '';
  latestPaths.metrics = res.metrics_path || '';
  document.getElementById('outCleaned').innerText = latestPaths.cleaned;
  document.getElementById('outValidation').innerText = latestPaths.validation;
  document.getElementById('outMetrics').innerText = latestPaths.metrics;
  renderUnbalanced(res.unbalanced_preview || []);
  renderValidation(res.validation_preview || []);
  renderMetrics(res.metrics_preview || []);
}

async function refreshStatusOnce() {
  try {
    const resp = await fetch('/api/run/status');
    const data = await resp.json();
    const running = !!(data && data.running);
    const prog = (data && data.progress) ? data.progress : {};
    setButtons(running);
    if (prog && (prog.current != null || prog.total != null || prog.detail != null)) {
      setProgress(prog.current, prog.total, prog.detail);
    }
    if (data && data.result) applyResult(data.result);
  } catch {}
}

function connectStream() {
  es = new EventSource('/api/stream');
  es.addEventListener('log', (e) => {
    try { appendLog(JSON.parse(e.data).message); } catch { appendLog(e.data); }
  });
  es.addEventListener('progress', (e) => {
    try {
      const d = JSON.parse(e.data);
      setProgress(d.current, d.total, d.detail);
    } catch {}
  });
  es.addEventListener('status', (e) => {
    try { setStatus(JSON.parse(e.data).message); } catch { setStatus(e.data); }
  });
  es.addEventListener('done', (e) => {
    try {
      const d = JSON.parse(e.data);
      const res = d.result || {};
      applyResult(res);
      if (res.cancelled) setStatus('已取消');
      else if (res.errors && res.errors.length) setStatus('完成（有错误）');
      else setStatus('完成');
    } catch { appendLog('done事件解析失败'); }
    setButtons(false);
    showTab('tab-results');
  });
  es.onerror = () => {};
}

const bind = (id, handler) => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('click', handler);
};

bind('btnReloadCfg', reloadCfg);
bind('btnSaveCfg', saveCfg);
bind('btnSaveCfg2', saveCfg);
bind('btnScan2', scanFiles);
bind('btnStart2', startRun);
bind('btnStart3', startRun);
bind('btnStop2', stopRun);
bind('btnStop3', stopRun);
bind('btnClearFiles', () => {
  const el = document.getElementById('filesPreview');
  if (el) el.innerText = '';
  setStatus('已清空文件预览');
});
bind('btnClearLogs', () => document.getElementById('logs').innerHTML = '');
bind('btnCopyLogs', async () => {
  const lines = Array.from(document.querySelectorAll('#logs .log-line')).map(x => x.innerText).join('\n');
  try { await navigator.clipboard.writeText(lines); setStatus('已复制日志'); } catch { setStatus('复制失败'); }
});

bind('btnApplyPreset', async () => {
  const key = document.getElementById('presetSelect').value;
  applyPresetToForm(key);
  await saveCfg();
});

bind('btnReloadQueryOptions', () => loadQueryOptions(true));
bind('btnQuery', () => runQuery(true));
bind('btnQueryPrev', () => { queryState.offset = Math.max(0, queryState.offset - queryState.limit); runQuery(false); });
bind('btnQueryNext', () => { queryState.offset = queryState.offset + queryState.limit; runQuery(false); });

document.getElementById('hostInfo').innerText = window.location.host;
reloadCfg().then(() => { refreshStatusOnce(); connectStream(); setInterval(refreshStatusOnce, 2000); });
loadQueryOptions(false);
</script>
</body>
</html>
